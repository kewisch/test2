---
name: PR Merged Actions

on:
  pull_request_target:
    branches: [main]
    types: [closed]

jobs:
  handle_merged_pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Get active milestone
        id: milestone
        env:
          PR_NUMBER: ${{  github.event.pull_request.number  }}
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/$GITHUB_REPOSITORY/milestones --jq '
                map(select(.state == "open" and .due_on != null))
                | sort_by(.due_on) | reverse
                | "number=" + (.[0].number|tostring)
                  + "\ntitle=" + .[0].title' | tee -a $GITHUB_OUTPUT

      - name: Thank you
        if: |
          github.event.pull_request.merged == true &&
          github.event.pull_request.author_association != 'OWNER' &&
          github.event.pull_request.author_association != 'MEMBER' &&
          github.event.pull_request.author_association != 'COLLABORATOR'
        env:
          PR_NUMBER: ${{  github.event.pull_request.number  }}
          GH_TOKEN: ${{ github.token }}
          MILESTONE: ${{ steps.milestone.outputs.title }}
          MESSAGE: >-
            Thanks for your contribution! Your pull request has been merged and will be part of
            ${{ steps.milestone.outputs.title }}. We appreciate the time and effort you put into
            improving Thunderbird. If you havenâ€™t already, youâ€™re welcome to join our Matrix chat
            for contributors. Itâ€™s where we discuss development and help each other out.
            https://matrix.to/#/#tb-android-dev:mozilla.org

            Hope to see you there! ğŸš€ğŸ“±ğŸ¦
        run: |
          gh pr comment $PR_NUMBER --repo $GITHUB_REPOSITORY --body "$MESSAGE"


      - name: Set active milestone on PR
        env:
          PR_NUMBER: ${{  github.event.pull_request.number  }}
          GH_TOKEN: ${{ github.token }}
          MILESTONE: ${{ steps.milestone.outputs.number }}
        run: |
          gh api --method PATCH /repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER -f milestone=$MILESTONE
